# Task Manager API

## Описание

Сервис управления задачами в распределённой системе с асинхронной обработкой и API на базе FastAPI. Задачи создаются через HTTP-запросы и обрабатываются асинхронно с использованием очереди (RabbitMQ). Статус выполнения и результат задачи можно получить в любой момент через API.

## Функционал

- Создание задач (с указанием типа и входных данных).
- Получение статуса конкретной задачи (PENDING, IN_PROGRESS, COMPLETED, FAILED, CANCELED).
- Получение списка задач с фильтрацией по статусу, дате создания и т.д.
- Обновление существующей задачи.
- Отмена выполнения задачи (CANCELED).
- Асинхронная обработка задач (через Celery или кастомный воркер на базе aio-pika/rabbitmq).
- Хранение результатов и истории задач в PostgreSQL.

## Технологии и инструменты

- Python 3.11
- FastAPI (обработка HTTP-запросов, документация по OpenAPI)
- PostgreSQL (хранение задач и их статусов)
- Redis (опционально, если вы используете кэш или broker, если не RabbitMQ)
- RabbitMQ (очередь задач)
- Alembic (миграции БД PostgreSQL)
- Docker и Docker Compose (развёртывание контейнеров)

## Установка и запуск

### Предварительные требования

- Docker и Docker Compose должны быть установлены на вашей машине.  
- (Опционально) Если хотите запускать локально без Docker, нужно установить PostgreSQL, RabbitMQ и Redis (если используется) вручную.

### Шаги запуска

1. Клонируйте репозиторий:
   ┌───────────────────────────────────────────────────────────────────
   │ git clone https://github.com/Dudi001/task_manager.git
   │ cd task-manager
   └───────────────────────────────────────────────────────────────────

2. В корне проекта должен находиться файл docker-compose.yml, где описаны:  
   - Сервис db (PostgreSQL).  
   - Сервис rabbitmq (или broker).  
   - Сервис redis (если используется).  
   - Сервис app (FastAPI/Приложение).  
   - Сервис worker (воркер для асинхронной обработки).

3. Постройте docker-образы и поднимите все контейнеры (в фоновом режиме):
   ┌───────────────────────────────────────────────────────────────────
   │ docker-compose build
   │ docker-compose up -d
   └───────────────────────────────────────────────────────────────────

   Это запустит базы данных, очереди и приложение (если прописано в docker-compose).

4. Примените миграции базы данных (Alembic), чтобы создать нужные таблицы:
   ┌───────────────────────────────────────────────────────────────────
   │ docker-compose run --rm app alembic upgrade head
   └───────────────────────────────────────────────────────────────────

   Данная команда выполнится внутри контейнера сервиса app, используя alembic.ini и файлы миграций в каталоге alembic/.

5. Проверьте логи и статус контейнеров:
   ┌───────────────────────────────────────────────────────────────────
   │ docker-compose logs -f
   └───────────────────────────────────────────────────────────────────
   Убедитесь, что всё запустилось без ошибок.

6. Откройте в браузере адрес (по умолчанию):
   http://localhost:8000/docs  
   где доступна документация Swagger по вашему FastAPI-приложению.  

7. Теперь можно отправлять запросы к API:  
   - POST /tasks/  (создать задачу)  
   - GET /tasks/{task_id} (узнать статус)  
   - GET /tasks/ (получить список с фильтрацией)  
   и т.д.

## Миграции Alembic

Миграции обеспечивают контроль версий структуры базы данных:

- Генерация новой миграции (после изменения моделей в app.models.py):
  ┌───────────────────────────────────────────────────────────────────
  │ docker-compose run --rm app alembic revision --autogenerate -m "Your message"
  └───────────────────────────────────────────────────────────────────

- Применение миграции:
  ┌───────────────────────────────────────────────────────────────────
  │ docker-compose run --rm app alembic upgrade head
  └───────────────────────────────────────────────────────────────────

- Откат на предыдущую версию (если нужно):
  ┌───────────────────────────────────────────────────────────────────
  │ docker-compose run --rm app alembic downgrade -1
  └───────────────────────────────────────────────────────────────────

## Тестирование

1. В контейнере:
   ┌───────────────────────────────────────────────────────────────────
   │ docker-compose run --rm app pytest
   └───────────────────────────────────────────────────────────────────

2. Локально (если установлены все зависимости):
   ┌───────────────────────────────────────────────────────────────────
   │ pytest
   └───────────────────────────────────────────────────────────────────

## Endpoints (Пример)

- POST /tasks/ - Создать задачу  
  Тело запроса (JSON):  
  {  
    "type": "some_type",  
    "data": {"key": "value"}  
  }  

- GET /tasks/ - Получить список задач (с фильтрацией по статусу, типу, дате и т.д.)  
- GET /tasks/{id} - Получить детальную информацию о задаче (статус, результат)  
- POST /tasks/{id}/retry - Повторно выполнить упавшую задачу  
- DELETE /tasks/{id} - Отменить (CANCELED) задачу  
